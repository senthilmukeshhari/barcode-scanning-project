{% extends 'layout.html' %} {% load static %} {% block stylesheets %}
<link rel="stylesheet" href="{% static 'css/style.css' %}" />
{% endblock %}

<!-- Title -->
{% block title %}
<title>Home Page | {{website_name}}</title>
{% endblock %}
<!-- End Title -->

<!-- Header Section -->
{% block header %}
<header>
  <h1>Computer Lab Entry/Exit System</h1>
</header>
{% endblock %} {% block content %}
<div class="container">
  <label for="scanInput">Scan Barcoede or Enter Roll No</label>
  <div class="barcode-scan-group">
    <input
      type="text"
      id="scanInput"
      placeholder="Scan barcode or Enter manually"
      autofocus="true"
      onkeydown="scanningProcess(event)"
    />
    <button type="button" id="scanBtn" onclick="scanningProcess(event)">
      Scan
    </button>
  </div>

  <div id="resultContainer">
    <!-- This will be populated with student details after scanning -->
  </div>

  <!-- Dashboard Section -->
  <div class="dashboard">
    <div class="card">
      <h3>Lab Status</h3>
      <p id="labStatus">{{lab_status}}</p>
    </div>
    <div class="card">
      <h3>Students in Lab</h3>
      <p id="usersInLab">{{students_in_lab}}</p>
    </div>
  </div>

  <!-- Live Notifications Section -->
  <div class="live-notifications">
    <h4>Live Notifications</h4>
    <div id="notifications">
      {% for notification in notifications %}
      <div class="notification">{{ notification }}</div>
      {% endfor %}
    </div>
  </div>
</div>
{% endblock %} {% block scripts %}
<script>
  const scaninputEl = document.getElementById("scanInput");

  const scanningProcess = (e) => {
    if (e.key === "Enter" || e.type === "click") {
      const barcodeValue = scaninputEl.value;

      fetch("{% url 'scan_barcode' %}", {
        method: "POST",
        headers: {
          "X-CSRFToken": "{{csrf_token}}",
          "Content-Type": "application/json",
        },
        body: JSON.stringify({ barcode: barcodeValue }),
      })
        .then((res) => res.json())
        .then((res) => {
          console.log(res)
          if(res.status == 'error'){
            alert(res.message)
            scaninputEl.value = "";
            scaninputEl.focus();
            return
          }
          const data = res.data;
          console.log("Data : ", data);
          const resultContainer = document.querySelector("#resultContainer");
          let result = `
            <div class="result ${res.status}">
              <div class="informations">
                <h1>${res.message}</h1>
                <label>Roll No : ${data.student}</label>
                <label>Name : ${data.student_name}</label>
                <label>Department : ${data.department}</label>
                <label>Section : ${data.section}</label>
                <label>${res.status === "entry" ? "Entry Time" : "Exit Time"} : ${res.status === "entry" ? data.entry_time : data.exit_time}</label>
              </div>
              <div class="profile">
                <img src="${data.profile_image}" alt="student profile" />
              </div>
            </div>
          `;
          resultContainer.innerHTML = result;

          // Update lab status and users in lab
          document.getElementById("labStatus").innerText = data.lab_status;
          document.getElementById("usersInLab").innerText = data.students_in_lab;

          // Update live notifications
          const notifications = document.getElementById("notifications");
          const notification = document.createElement("div");
          notification.className = "notification";
          notification.innerText = `User ${data.student} ${res.status === "entry" ? "entered" : "exited"} the lab.`;
          notifications.prepend(notification);

          scaninputEl.value = "";
          scaninputEl.focus();
        })
        .catch((error) => console.error("Error : ", error));
    }
  };
</script>
{% endblock %}
